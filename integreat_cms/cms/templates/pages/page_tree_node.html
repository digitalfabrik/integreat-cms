{% load i18n %}
{% load content_filters %}
{% load page_filters %}
{% load tree_filters %}
<tr id="page-{{ page.page_id }}-drop-left" data-drop-id="{{ page.page_id }}" data-drop-position="left" class="drop {% if page_depth == 0 %} drop-between {% endif %} h-3 -m-3 hidden level-{{page_depth}}"><td colspan="9"><div><span></span></div></td></tr>
<tr id="page-{{ page.page_id }}" data-drop-id="{{ page.page_id }}" data-drop-position="last-child" class="drop drop-on border-t border-b border-solid border-gray-200 hover:bg-gray-100 child {% if page_depth > 0 %} hidden level-{{page_depth}}{% endif %}">
    <td class="pl-4">
        <input type="checkbox" name="selected_ids[]" value="{{ page.page_id }}" class="bulk-select-item">
    </td>
    <td class="hierarchy single_icon whitespace-nowrap">
        <span data-drag-id="{{ page.page_id }}"
              data-node-descendants="{{ page|get_descendants }}"
              class="{% if enable_drag_and_drop %}drag cursor-move{% else %}cursor-not-allowed{% endif %} text-gray-800 inline-block pl-4 align-middle"
              {% if enable_drag_and_drop %}
              draggable="true"
              title="{% trans 'Change the order and position of the pages with drag & drop.' %}"
              {% else %}
              title="{% trans 'Drag & drop is disabled when filters are applied.' %}"
              {% endif %}>
            <i data-feather="move"></i>
        </span>
        {% if page.children|length %}
        <span class="collapse-subpages cursor-pointer inline-block align-middle"
              title="{% trans 'Collapse all subpages' %}"
              data-page-id="{{ page.page_id }}"
              data-page-children="{{ page|get_children }}">
                <i data-feather="chevron-right"></i>
            </span>
        {% endif %}
    </td>
    <td>
        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}" class="block py-3 pl-2 text-gray-800">
            {% if page.base_title %}
                {{ page.base_title }}
            {% else %}
                <i>{% trans 'Translation not available' %}</i>
            {% endif %}
        </a>
    </td>
    {% get_current_language as LANGUAGE_CODE %}
    {% get_language LANGUAGE_CODE as backend_language %}
    {% if backend_language and backend_language != language %}
        <td>
            <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=LANGUAGE_CODE %}" class="block py-3 pl-2 text-gray-800">
                <div class="translation-title">
                    {% if page.title %}
                        {{ page.title }}
                    {% else %}
                        <i>{% trans 'Translation not available' %}</i>
                    {% endif %}
                </div>
            </a>
        </td>
    {% endif %}
    <td class="whitespace-nowrap">
        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}" class="block py-3 pl-2 text-gray-800">
            {% for tag in page_translation.tags %}
                <span class="bg-orange-400 text-white rounded px-2 py-1">{{ tag }}</span>
            {% endfor %}
        </a>
    </td>
    <td class="whitespace-nowrap">
        <div class="block py-3 pl-2 text-gray-800">
            <div class="lang-grid">
                {% spaceless %}
                    {% for other_language in languages %}
                        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=other_language.slug %}"
                            class="{{ other_language.slug }}">
                            <div id="translation-icon">
                                {% if page|get_translation_state:other_language.id == 'in_translation' %}
                                    <span title="{% trans 'Currently in translation' %}">
                                        <i data-feather="clock" class="{% if other_language == language %}text-blue-500{% else %}text-gray-800{% endif %}"></i>
                                    </span>
                                {% elif page|get_translation_state:other_language.id == 'outdated' %}
                                    <span title="{% trans 'Translation outdated' %}">
                                        <i data-feather="alert-triangle" class="{% if other_language == language %}text-yellow-500{% else %}text-gray-800{% endif %}"></i>
                                    </span>
                                {% elif page|get_translation_state:other_language.id == 'missing' %}
                                    <span title="{% trans 'Translation missing' %}" class="no-trans">
                                        <i data-feather="x" class="{% if other_language == language %}text-red-500{% else %}text-gray-800{% endif %}"></i>
                                    </span>
                                {% else %}
                                    <span title="{% trans 'Translation up-to-date' %}">
                                        <i data-feather="check" class="{% if other_language == language %}text-green-500{% else %}text-gray-800{% endif %}"></i>
                                    </span>
                                {% endif %}
                            </div>
                            <div id="ajax-icon" class="hidden">
                                <span title="{% trans 'Currently in translation' %}">
                                    <i data-feather="clock" class="{% if other_language == language %}text-blue-500{% else %}text-gray-800{% endif %}"></i>
                                </span>
                            </div>
                        </a>
                    {% endfor %}
                {% endspaceless %}
            </div>
        </div>
    </td>
    <td>
        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}" class="block py-3 pl-2 text-gray-800">
            {{ page_translation.get_status_display }}
        </a>
    </td>
    <td>
        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}" class="block py-3 pl-2 text-gray-800">
            {{ page_translation.last_updated|date:"d.m.Y, H:i" }}
        </a>
    </td>
    <td class="pl-2 pr-4 py-3 text-right flex flex-nowrap gap-2">
        <a href="{% url 'view_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}"
           target="_blank" rel="noopener noreferrer" title="{% trans 'View page as preview' %}" class="btn-icon">
            <i data-feather="eye"></i>
        </a>
        {% if page_translation.status == PUBLIC %}
            <a href="{{ WEBAPP_URL }}{{ page_translation.get_absolute_url }}"
                rel="noopener noreferrer" target="_blank" title="{% trans 'Open page in web app' %}" class="btn-icon">
                <i data-feather="external-link"></i>
            </a>
        {% else %}
            <button title="{% trans 'This page cannot be opened in the web app, because it is not public.' %}" class="btn-icon" disabled>
                <i data-feather="external-link"></i>
            </button>
        {% endif %}
        <a href="{% url 'edit_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}" title="{% trans 'Edit page' %}" class="btn-icon">
            <i data-feather="edit"></i>
        </a>

        <button title="{% trans 'Archive page' %}" class="confirmation-button btn-icon"
                data-confirmation-title="{{ archive_dialog_title }}"
                data-confirmation-text="{{ archive_dialog_text }}"
                data-confirmation-subject="{{ page.best_translation.title }}"
                data-action="{% url 'archive_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}">
            <i data-feather="archive"></i>
        </button>
        {% if perms.cms.delete_page %}
            {% if page.children|length %}
                <button title="{% trans 'You cannot delete a page which has subpages.' %}&#013;{% trans 'This also involves archived subpages.' %}" class="btn-icon" disabled>
                    <i data-feather="trash-2"></i>
                </button>
            {% else %}
                <button title="{% trans 'Delete page' %}" class="confirmation-button btn-icon"
                        data-confirmation-title="{{ delete_dialog_title }}"
                        data-confirmation-text="{{ delete_dialog_text }}"
                        data-confirmation-subject="{{ page.best_translation.title }}"
                        data-action="{% url 'delete_page' page_id=page.page_id region_slug=region.slug language_slug=language.slug %}">
                    <i data-feather="trash-2"></i>
                </button>
            {% endif %}
        {% endif %}
        {% if region.short_urls_enabled and request.user.expert_mode %}
            {% if page_translation %}
            <button data-copy-to-clipboard="{{ page_translation.short_url }}" title="{% trans 'Copy short link' %}" class="btn-icon">
                <i data-feather="copy"></i>
            </button>
            {% else %}
            <button title="{% trans 'You cannot copy a short link of a page which has no translation.' %}" class="btn-icon" disabled>
                <i data-feather="copy"></i>
            </button>
            {% endif %}
        {% endif %}
    </td>
</tr>

{% for child in page.children %}
    {% include "pages/page_tree_node.html" with page=child page_depth=page_depth|add:"1" %}
{% endfor %}